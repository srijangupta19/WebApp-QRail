<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lot Details - Indian Railways</title>
  <style>
    /* same CSS as before (kept untouched) */
    body { font-family: 'Times New Roman', Times, serif; background:#f0f2f5; margin:0; color:#333; display:flex; flex-direction:column; min-height:100vh; }
    .header { width:100%; padding:10px 20px; background:#0d47a1; color:white; display:flex; justify-content:space-between; align-items:center; box-sizing:border-box; box-shadow:0 2px 4px rgba(0,0,0,0.1);}
    .header .logo { text-align:right; line-height:1.2; }
    .header .logo .app-name { font-size:1.5em; font-weight:bold; }
    .header .logo .app-subname { font-size:0.9em; display:block; }
    .header .back-button { font-size:1.5em; color:white; text-decoration:none; cursor:pointer; }
    .top-button-container { width:100%; padding:10px 20px; box-sizing:border-box; display:flex; justify-content:flex-end; margin-top:10px; }
    .main-container { display:flex; flex-wrap:wrap; padding:20px; gap:20px; flex-grow:1; }
    .btn.back-to-portal { background:#0056b3; margin-bottom:20px; display:flex; align-items:center; justify-content:center; padding:15px; border-radius:10px; font-size:1.1em; font-weight:bold; color:white; border:none; cursor:pointer; box-shadow:0 4px 6px rgba(0,0,0,0.1); transition:background-color 0.3s; text-decoration:none; width:100%;}
    .content-section { background:white; padding:20px; border-radius:8px; box-shadow:0 4px 8px rgba(0,0,0,0.1); flex:1 1 300px; }
    .content-section.history-section { flex:2 1 400px; display:flex; flex-direction:column; }
    .history-list { list-style:none; padding:0; margin:0; }
    .history-list li { border-bottom:1px solid #eee; padding:10px 0; }
    h2 { margin-top:0; font-size:1.5em; border-bottom:2px solid #ccc; padding-bottom:10px; margin-bottom:20px; }
    .details-card { border:1px solid #ddd; border-radius:6px; padding:15px; margin-bottom:20px; background:#f9f9f9; }
    .details-card p { margin:5px 0; line-height:1.5; }
    .details-card strong { display:inline-block; min-width:100px; }
    .feed-faults-btn { background:#2e7d32; color:white; border:none; padding:15px 30px; font-size:1em; font-weight:bold; border-radius:8px; cursor:pointer; text-align:center; transition:background-color 0.3s ease; }
    .feed-faults-btn:hover { background:#1b5e20; }
    @media (max-width:768px) { .main-container { flex-direction:column; } }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDVaRCfAz11NtcXp0WpDhHCc85QuyEbFSk",
      authDomain: "sih-trial-122f8.firebaseapp.com",
      projectId: "sih-trial-122f8",
      storageBucket: "sih-trial-122f8.firebasestorage.app",
      messagingSenderId: "773497361291",
      appId: "1:773497361291:web:3dc8ed3f42164c144c158e",
      measurementId: "G-VJGRQZ71CB"
    };

    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentQR = new URLSearchParams(window.location.search).get("qr");
    const sections = ["Rail", "Rail Clip", "Sleeper", "Liner", "Rail Pad", "Joint"];

    // Fetch and Render Data
    async function fetchDetails() {
      if (!currentQR) {
        document.querySelector('.main-container').innerHTML = '<p>No QR code scanned. Please go back and scan a QR code.</p>';
        return;
      }

      const historyList = document.getElementById("historyList");
      const lotDetailsContainer = document.getElementById("lotDetails");

      historyList.innerHTML = '<p>Loading history...</p>';
      lotDetailsContainer.innerHTML = '<p>Loading details...</p>';

      try {
        if (!auth.currentUser) {
          console.log("Waiting for authentication...");
          return;
        }

        // History
        const qrRef = doc(db, "railway_parts", currentQR);
        const qrSnap = await getDoc(qrRef);
        if (qrSnap.exists()) {
          const data = qrSnap.data();
          const inspectionHistory = data.inspection_dates || [];
          historyList.innerHTML = "";
          if (inspectionHistory.length === 0) {
            historyList.innerHTML = "<p>No inspection history available.</p>";
          } else {
            inspectionHistory.forEach(h => {
              const li = document.createElement("li");
              li.textContent = `Date: ${h.date}, Status: ${h.status}`;
              historyList.appendChild(li);
            });
          }
        } else {
          historyList.innerHTML = "<p>No QR lot found in database.</p>";
        }

        // Parts
        const partsRef = collection(db, "railway_parts", currentQR, "parts");
        const partsSnap = await getDocs(partsRef);
        lotDetailsContainer.innerHTML = "";

        if (partsSnap.empty) {
          lotDetailsContainer.innerHTML = "<p>No parts found for this QR code.</p>";
        } else {
          const partsByType = {};
          partsSnap.forEach(docSnap => {
            const data = { id: docSnap.id, ...docSnap.data() };
            const type = data.part_type.toLowerCase();
            if (!partsByType[type]) partsByType[type] = [];
            partsByType[type].push(data);
          });

          sections.forEach(sectionName => {
            const type = sectionName.toLowerCase();
            if (partsByType[type]) {
              const partData = partsByType[type][0];
              const detailsCard = createDetailsCard(partData);
              lotDetailsContainer.appendChild(detailsCard);
            }
          });
        }
      } catch (err) {
        console.error("Error fetching data:", err);
        lotDetailsContainer.innerHTML = "<p>Error loading details.</p>";
        historyList.innerHTML = "<p>Error loading history.</p>";
      }
    }

    function createDetailsCard(data) {
      const cardDiv = document.createElement("div");
      cardDiv.className = "details-card";

      // Faults display
      let faultsHTML = "<ul>";
      if (data.faults) {
        for (const [key, val] of Object.entries(data.faults)) {
          faultsHTML += `<li>${key}: ${val}</li>`;
        }
      } else {
        faultsHTML += "<li>No faults recorded</li>";
      }
      faultsHTML += "</ul>";

      cardDiv.innerHTML = `
        <h3>${data.part_type}</h3>
        <p><strong>Vendor:</strong> ${data.vendor || "N/A"}</p>
        <p><strong>Mfg. Date:</strong> ${data.manufacture_date || "N/A"}</p>
        <p><strong>Lot id:</strong> ${data.lot_id || "N/A"}</p>
        <p><strong>Zone:</strong> ${data.zone || "N/A"}</p>
        <p><strong>Faults:</strong> ${faultsHTML}</p>
      `;
      return cardDiv;
    }

    window.goToFaults = function() {
      if (currentQR) {
        window.location.href = `feed_faults.html?qr=${encodeURIComponent(currentQR)}`;
      } else {
        alert("No QR code detected.");
      }
    };

    async function initApp() {
      try {
        if (initialAuthToken) {
          await signInWithCustomToken(auth, initialAuthToken);
        } else {
          await signInAnonymously(auth);
        }
        fetchDetails();
      } catch (error) {
        console.error("Firebase auth failed:", error);
        document.querySelector('.main-container').innerHTML = '<p>Authentication failed.</p>';
      }
    }

    initApp();
  </script>
</head>
<body>
  <header class="header">
    <button class="back-button" onclick="window.location.href='scan.html'">&#x2630;</button>
    <div class="logo">
      <span class="app-name">भारतीय रेल</span>
      <span class="app-subname">INDIAN RAILWAYS</span>
    </div>
  </header>

  <div class="top-button-container">
    <button class="feed-faults-btn" onclick="goToFaults()">FEED FAULTS</button>
  </div>

  <main class="main-container">
    <a href="index.html" class="btn back-to-portal">⬅ Back to Home</a>
    <section class="content-section">
      <h2>Lot Details</h2>
      <div id="lotDetails"></div>
    </section>
    <section class="content-section history-section">
      <h2>History</h2>
      <ul id="historyList"></ul>
    </section>
  </main>
</body>
</html>
